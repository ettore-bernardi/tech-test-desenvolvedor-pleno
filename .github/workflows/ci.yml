name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  rubocop:
    name: Run RuboCop
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect project directory (src or root)
        id: projectdir
        run: |
          if [ -f "src/Gemfile" ]; then
            echo "dir=src" >> "$GITHUB_OUTPUT"
          else
            echo "dir=." >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.4
          bundler-cache: false

      - name: Install rubocop gems
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          gem install bundler
          bundle install
          bundle add rubocop rubocop-rails rubocop-rspec --group=development --skip-install || true

      - name: Run RuboCop
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          bundle exec rubocop --format progress

  test:
    name: Run RSpec
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect project directory (src or root)
        id: projectdir
        run: |
          if [ -f "src/Gemfile" ]; then
            echo "dir=src" >> "$GITHUB_OUTPUT"
          elif [ -f "Gemfile" ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          else
            echo "dir=." >> "$GITHUB_OUTPUT"
            echo "Warning: no Gemfile found in repo root or src/ — adjust workflow if your project is elsewhere."
          fi

      - name: Show chosen dir
        run: |
          echo "Using project dir: ${{ steps.projectdir.outputs.dir }}"
          ls -la "${{ steps.projectdir.outputs.dir }}" || true

      - name: Set up Ruby (match Gemfile's declared version)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.4
          bundler-cache: false

      - name: Install system packages for sqlite
        run: sudo apt-get update -yqq && sudo apt-get install -yqq libsqlite3-dev sqlite3 build-essential pkg-config

      - name: Detect Bundler version from Gemfile.lock (if present)
        id: bundlerv
        run: |
          DIR="${{ steps.projectdir.outputs.dir }}"
          if [ -f "$DIR/Gemfile.lock" ]; then
            # get version under "BUNDLED WITH" (last non-empty line after the marker)
            VER=$(awk '/^BUNDLED WITH/{getline; print $1}' "$DIR/Gemfile.lock" | tr -d ' \t\r\n')
            if [ -n "$VER" ]; then
              echo "bundler_version=$VER" >> "$GITHUB_OUTPUT"
            else
              echo "bundler_version=" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "bundler_version=" >> "$GITHUB_OUTPUT"
          fi
          echo "Detected bundler version: ${{ steps.bundlerv.outputs.bundler_version }}"

      - name: Install correct Bundler (if detected) or latest
        run: |
          VER="${{ steps.bundlerv.outputs.bundler_version }}"
          if [ -n "$VER" ]; then
            echo "Installing bundler $VER"
            gem install bundler -v "$VER"
          else
            echo "No bundler version detected in Gemfile.lock — installing latest bundler"
            gem install bundler
          fi

      - name: Check for duplicate rspec-rails entries (quick warning)
        run: |
          DIR="${{ steps.projectdir.outputs.dir }}"
          if [ -f "$DIR/Gemfile" ]; then
            COUNT=$(grep -E "^\s*gem ['\"]rspec-rails['\"]" -n "$DIR/Gemfile" | wc -l || true)
            if [ "$COUNT" -gt 1 ]; then
              echo "ERROR: rspec-rails appears $COUNT times in $DIR/Gemfile. Remove duplicates and keep a single declaration."
              exit 1
            else
              echo "rspec-rails occurrences in Gemfile: $COUNT"
            fi
          else
            echo "No Gemfile found to check duplicates."
          fi

      - name: Cache gems
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          path: ${{ steps.projectdir.outputs.dir }}/vendor/bundle

      - name: Install gems (using pinned bundler)
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          DIR="."
          if [ -f Gemfile.lock ]; then
            # prefer explicit bundler version if detected
            BVER="${{ steps.bundlerv.outputs.bundler_version }}"
            if [ -n "$BVER" ]; then
              echo "Using bundle _${BVER}_ install"
              bundle _${BVER}_ config path vendor/bundle
              bundle _${BVER}_ install --jobs 4 --retry 3
            else
              echo "Using default bundle install"
              bundle config path vendor/bundle
              bundle install --jobs 4 --retry 3
            fi
          else
            echo "No Gemfile.lock found, running bundle install"
            bundle config path vendor/bundle
            bundle install --jobs 4 --retry 3
          fi

      - name: Create config/database.yml (sqlite for test)
        run: |
          mkdir -p "${{ steps.projectdir.outputs.dir }}/config"
          printf '%s\n' \
            "test:" \
            "  adapter: sqlite3" \
            "  database: db/test.sqlite3" \
            "  pool: 5" \
            "  timeout: 5000" \
            > "${{ steps.projectdir.outputs.dir }}/config/database.yml"

      - name: Ensure db folder exists
        run: mkdir -p "${{ steps.projectdir.outputs.dir }}/db"

      - name: Prepare test DB (load schema)
        env:
          RAILS_ENV: test
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          if [ -f db/schema.rb ]; then
            bundle exec rails db:schema:load RAILS_ENV=test
          elif [ -f db/structure.sql ]; then
            bundle exec rails db:structure:load RAILS_ENV=test
          else
            bundle exec rails db:create db:migrate RAILS_ENV=test || true
          fi

      - name: Run RSpec
        env:
          RAILS_ENV: test
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          if [ -d spec ]; then
            bundle exec rspec --format documentation
          elif [ -f Rakefile ]; then
            bundle exec rake test || bundle exec rake
          else
            echo "No tests found (no spec/ directory)."
          fi

      - name: Upload rspec output artifact (logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rspec-output
          path: ${{ steps.projectdir.outputs.dir }}/tmp/**

  security:
    name: Brakeman security scan
    runs-on: ubuntu-latest
    needs: test       # opcional: aguarda os testes, remove se não quiser dependência

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect project directory (src or root)
        id: projectdir
        run: |
          if [ -f "src/Gemfile" ]; then echo "dir=src" >> "$GITHUB_OUTPUT"; else echo "dir=." >> "$GITHUB_OUTPUT"; fi

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.4

      - name: Install system deps (jq used to parse JSON)
        run: sudo apt-get update -yqq && sudo apt-get install -yqq jq

      - name: Install brakeman gem
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          gem install brakeman -v ">= 7.0" --no-document

      - name: Run Brakeman and write JSON report
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          set -o pipefail
          # run brakeman quiet and output json
          brakeman -q -o brakeman-report.json || true
          # show a short summary so logs are informative
          echo "Brakeman summary:"
          cat brakeman-report.json | jq '.scan_info | {rails_version, ruby_version, brakeman_version, security_warnings, duration}'

      - name: Upload Brakeman report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brakeman-report
          path: ${{ steps.projectdir.outputs.dir }}/brakeman-report.json

      - name: Fail if High-confidence warnings found (adjust threshold here)
        if: always()
        working-directory: ${{ steps.projectdir.outputs.dir }}
        run: |
          # total warnings
          TOTAL=$(jq '.warnings | length' brakeman-report.json)
          # high confidence warnings (confidence string may be "High" in your output)
          HIGH=$(jq '[.warnings[] | select(.confidence=="High")] | length' brakeman-report.json)
          echo "Total Brakeman warnings: $TOTAL"
          echo "High confidence warnings: $HIGH"
          # Adjust the rule below: fail if HIGH > 0 or TOTAL > 10, etc.
          if [ "$HIGH" -gt 0 ]; then
            echo "Failing because there are $HIGH high-confidence Brakeman warnings."
            exit 1
          fi
          # optional threshold on total warnings:
          MAX_TOTAL=50
          if [ "$TOTAL" -gt "$MAX_TOTAL" ]; then
            echo "Failing because total warnings ($TOTAL) > $MAX_TOTAL"
            exit 1
          fi
          echo "Brakeman policy passed (no high-confidence warnings and total <= $MAX_TOTAL)."
