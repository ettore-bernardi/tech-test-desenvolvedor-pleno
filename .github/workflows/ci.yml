name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Run RSpec
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: src

    env:
      RAILS_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: false

      - name: Cache gems
        uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-gems-${{ hashFiles('src/Gemfile.lock') }}
          path: src/vendor/bundle

      - name: Install system packages for sqlite
        run: sudo apt-get update -yqq && sudo apt-get install -yqq libsqlite3-dev sqlite3 build-essential pkg-config

      - name: Install gems
        run: |
          gem install bundler
          cd src
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Create config/database.yml (sqlite for test)
        run: |
          mkdir -p src/config
          cat > src/config/database.yml <<'YML'
          test:
            adapter: sqlite3
            database: db/test.sqlite3
            pool: 5
            timeout: 5000
          YML

      - name: Ensure db folder exists
        run: mkdir -p src/db

      - name: Prepare test DB (load schema)
        env:
          RAILS_ENV: test
        run: |
          cd src
          bundle exec rails db:schema:load RAILS_ENV=test

      - name: Run RSpec
        env:
          RAILS_ENV: test
        run: |
          cd src
          bundle exec rspec --format documentation

      - name: Upload rspec output artifact (logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rspec-output
          path: src/tmp/**, src/tmp/**/*, src/tmp || src/tmp
