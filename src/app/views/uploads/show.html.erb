<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Logs do Upload #<%= @upload.id %></h2>
  <div id="processing-indicator" class="d-none">
  </div>
</div>

<div class="mb-3">
  <strong>Status do Upload:</strong> 
  <span class="badge bg-secondary" id="upload-status"><%= @upload.status %></span>
  <span class="ms-3">
    <strong>Arquivos:</strong> 
    <span id="processed-count"><%= @logs.count %></span> / <span id="total-files"><%= @upload.files_count %></span>
  </span>
</div>

<table class="table table-striped table-bordered">
  <thead class="table-dark">
    <tr>
      <th>Status</th>
      <th>Arquivo</th>
      <th>Mensagem</th>
      <th>Detalhes</th>
      <th>Criado em</th>
    </tr>
  </thead>

  <tbody id="logs-table-body">
     <% if @logs.present? %>
         <% @logs.each do |l| %>
        <tr data-log-id="<%= l.id %>">
          <td class="view-raw-cell text-center">
            <% if l.raw_data.present? %>
              <button type="button"
                      class="btn btn-sm btn-outline-primary view-raw-btn"
                      data-log-id="<%= l.id %>">
                Ver raw
              </button>

              <button type="button"
                      class="btn btn-sm btn-outline-danger delete-raw-btn"
                      data-log-id="<%= l.id %>">
                Excluir log
              </button>
            <% else %>
              <span class="text-muted">—</span>
            <% end %>
          </td>
          <td class="text-center">
            <% case l.status %>
            <% when "finished", "success", "processed" %>
              <span class="badge bg-success"><%= l.status %></span>
            <% when "failed", "error" %>
              <span class="badge bg-danger"><%= l.status %></span>
            <% else %>
              <span class="badge bg-secondary"><%= l.status.presence || '-' %></span>
            <% end %>
          </td>

          <td><%= l.file_name %></td>

          <td style="white-space:pre-wrap; max-width:250px;"><%= l.message.presence || '-' %></td>

          <td style="max-width:350px;">
            <% begin %>
              <pre class="bg-light p-2 border" style="white-space: pre-wrap; font-size:0.85rem;"><%= JSON.pretty_generate(l.parsed_json || {}) rescue (l.parsed_json || {}).inspect %></pre>
            <% rescue %>
              <pre class="bg-light p-2 border" style="white-space: pre-wrap; font-size:0.85rem;"><%= (l.parsed_json || {}).inspect %></pre>
            <% end %>
          </td>

          <td class="text-center"><%= l.created_at.strftime('%d/%m/%Y %H:%M:%S') %></td>
        </tr>
      <% end %>
    <% else %>
      <tr><td colspan="5" class="text-center">Nenhum log para este upload.</td></tr>
    <% end %>
  </tbody>
</table>

<div class="modal fade" id="rawModal" tabindex="-1" aria-labelledby="rawModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rawModalLabel">Conteúdo do EML</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <strong>Arquivo:</strong> <span id="rawModalFileName">-</span>
          <strong class="ms-3">Status:</strong> <span id="rawModalStatus">-</span>
        </div>

        <div id="rawModalSpinner" class="text-center my-4 d-none">
          <div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div>
        </div>

        <pre id="rawModalContent" class="bg-dark text-white p-3" style="white-space: pre-wrap; font-size:0.85rem; max-height:70vh; overflow:auto;"></pre>
      </div>
      <div class="modal-footer">
        <a id="rawModalDownload" class="btn btn-outline-secondary d-none" href="#" download>Baixar .eml</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
<script>
  (function() {
    const uploadId = <%= @upload.id %>;
    const logsTableBody = document.getElementById('logs-table-body');
    const processingIndicator = document.getElementById('processing-indicator');
    const uploadStatus = document.getElementById('upload-status');
    const processedCount = document.getElementById('processed-count');
    const totalFiles = document.getElementById('total-files');
    let currentLogIds = new Set();
    let pollInterval = null;
    let isProcessing = false;

    // Funções utilitárias (igual ao seu código)
    function getStatusBadge(status) {
      if (['finished', 'success', 'processed'].includes(status)) {
        return '<span class="badge bg-success">' + status + '</span>';
      } else if (['failed', 'error'].includes(status)) {
        return '<span class="badge bg-danger">' + status + '</span>';
      } else {
        return '<span class="badge bg-secondary">' + (status || '-') + '</span>';
      }
    }

    function getUploadStatusBadge(status) {
      const badges = {
        'finished': '<span class="badge bg-success">Concluído</span>',
        'processing': '<span class="badge bg-warning">Processando</span>',
        'failed': '<span class="badge bg-danger">Falhou</span>',
        'pending': '<span class="badge bg-secondary">Pendente</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
    }

    function formatJSON(obj) {
      try {
        return JSON.stringify(obj, null, 2);
      } catch (e) {
        return String(obj);
      }
    }

    function escapeHtml(text) {
      if (text === null || typeof text === 'undefined') return '-';
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // Atualiza a tabela incluindo o botão "Ver raw"
    function updateLogsTable(logs) {
      if (!logs || logs.length === 0) {
        logsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum log para este upload.</td></tr>';
        currentLogIds.clear();
        return;
      }

      const newLogIds = new Set(logs.map(log => log.id));
      const hasNewLogs = logs.length !== currentLogIds.size || Array.from(newLogIds).some(id => !currentLogIds.has(id));

      if (hasNewLogs) {
        currentLogIds.clear();
        logsTableBody.innerHTML = logs.map(log => {
          currentLogIds.add(log.id);
          return `
            <tr data-log-id="${log.id}">
              <td class="text-center">${getStatusBadge(log.status)}</td>
              <td>${escapeHtml(log.file_name)}</td>
              <td style="white-space:pre-wrap; max-width:250px;">${escapeHtml(log.message)}</td>
              <td style="max-width:350px;">
                <pre class="bg-light p-2 border" style="white-space: pre-wrap; font-size:0.85rem;">${escapeHtml(formatJSON(log.parsed_json || {}))}</pre>
              </td>
              <td class="text-center">${escapeHtml(log.created_at)}</td>
            </tr>
          `;
        }).join('');
      }
    }

    // --- NOVO: delegação de clique para abrir modal de raw
    // adiciona coluna de ação (ver raw) dinamicamente ao lado esquerdo
    function ensureActionColumnHeader() {
      const thead = document.querySelector('table thead tr');
      if (!thead) return;
      // Se não existir o th de Ações, insere antes do primeiro th
      if (!thead.querySelector('th.actions')) {
        const th = document.createElement('th');
        th.className = 'actions';
        th.innerText = 'Ações';
        thead.insertBefore(th, thead.firstChild);
      }
    }

    function addActionButtonsToRows() {
      // Insere botão 'Ver raw' na primeira coluna de cada linha
      document.querySelectorAll('#logs-table-body tr').forEach(row => {
        if (row.querySelector('.view-raw-cell')) return; // já tem
        const id = row.getAttribute('data-log-id');
        const td = document.createElement('td');
        td.className = 'view-raw-cell text-center';
        td.innerHTML = `<button type="button" class="btn btn-sm btn-outline-primary view-raw-btn" data-log-id="${id}">Ver raw</button>`;
        row.insertBefore(td, row.firstChild);
      });
    }

    // Função para abrir o modal e buscar raw
    function openRawModal(logId) {
      const modalEl = document.getElementById('rawModal');
      const fileNameEl = document.getElementById('rawModalFileName');
      const statusEl = document.getElementById('rawModalStatus');
      const contentEl = document.getElementById('rawModalContent');
      const spinner = document.getElementById('rawModalSpinner');
      const downloadLink = document.getElementById('rawModalDownload');

      // mostrar modal (Bootstrap 5)
      const rawModal = new bootstrap.Modal(modalEl);
      fileNameEl.textContent = 'Carregando...';
      statusEl.textContent = '';
      contentEl.textContent = '';
      downloadLink.classList.add('d-none');
      spinner.classList.remove('d-none');

      rawModal.show();

      fetch(`/email_logs/${logId}/raw`, {
        headers: { 'Accept': 'application/json' }
      })
        .then(resp => {
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          return resp.json();
        })
        .then(data => {
          spinner.classList.add('d-none');
          fileNameEl.textContent = data.file_name || `#${data.id}`;
          statusEl.textContent = data.status || '-';
          // Preenche o pre com texto puro (não HTML) para preservar o conteúdo
          contentEl.textContent = data.raw || '';

          // permite download como arquivo .eml (cria blob)
          try {
            const blob = new Blob([data.raw || ''], { type: 'message/rfc822;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = (data.file_name && data.file_name.trim().length > 0) ? data.file_name : `email_${data.id}.eml`;
            downloadLink.classList.remove('d-none');
          } catch (e) {
            downloadLink.classList.add('d-none');
          }
        })
        .catch(err => {
          spinner.classList.add('d-none');
          contentEl.textContent = 'Erro ao buscar conteúdo: ' + (err.message || err);
        });
    }

    document.addEventListener('click', function(e) {
      const viewBtn = e.target.closest('.view-raw-btn');
      if (viewBtn) {
        const id = viewBtn.getAttribute('data-log-id');
        if (id) openRawModal(id);
        return;
      }

      const deleteBtn = e.target.closest('.delete-raw-btn');
      if (deleteBtn) {
        e.stopPropagation();
        const id = deleteBtn.getAttribute('data-log-id');
        if (!id) return;
    
        if (!confirm('Tem certeza que deseja excluir o raw deste log?')) return;

        const tokenMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = tokenMeta ? tokenMeta.content : '';

        const originalHtml = deleteBtn.innerHTML;
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
    
        fetch(`/email_logs/${id}/clear_raw`, {
          method: 'PATCH',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          credentials: 'same-origin',
          body: null
        })
          .then(async resp => {
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.success) {
              const err = data.error || `HTTP ${resp.status}`;
              throw new Error(err);
            }
            const row = document.querySelector(`tr[data-log-id="${id}"]`);
            if (row) {
              const actionTd = row.querySelector('.view-raw-cell');
              if (actionTd) actionTd.innerHTML = '<span class="text-muted">—</span>';

              const msgCell = row.cells[2];
              if (msgCell) msgCell.textContent = '-';

              const detailsCell = row.cells[3];
              if (detailsCell) {
                const pre = detailsCell.querySelector('pre');
                if (pre) pre.textContent = '{}';
                else detailsCell.textContent = '{}';
              }
            }
            return true;
          })
          .catch(err => {
            console.error('Erro ao excluir raw:', err);
            alert('Erro ao excluir raw: ' + (err.message || err));
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalHtml;
          });
        return;
      }
    });

    function fetchLogs() {
      if (isProcessing) return;
      isProcessing = true;
      if (processingIndicator) processingIndicator.classList.remove('d-none');

      fetch(`/uploads/${uploadId}/logs_json`)
        .then(response => response.json())
        .then(data => {
          updateLogsTable(data.logs);
          ensureActionColumnHeader();
          addActionButtonsToRows();

          // atualizar status do upload
          if (uploadStatus && uploadStatus.parentNode) {
            uploadStatus.outerHTML = getUploadStatusBadge(data.upload_status);
          }
          processedCount.textContent = data.processed_files;

          if (data.processed_files >= data.total_files && ['finished', 'failed'].includes(data.upload_status)) {
            setTimeout(() => {
              if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
              }
              if (processingIndicator) processingIndicator.classList.add('d-none');
            }, 5000);
          }
        })
        .catch(error => {
          console.error('Erro ao buscar logs:', error);
        })
        .finally(() => {
          isProcessing = false;
        });
    }

    // Inicializar IDs atuais
    document.querySelectorAll('[data-log-id]').forEach(row => {
      currentLogIds.add(parseInt(row.getAttribute('data-log-id')));
    });

    // start polling
    pollInterval = setInterval(fetchLogs, 2000);
    fetchLogs();
  })();
</script>